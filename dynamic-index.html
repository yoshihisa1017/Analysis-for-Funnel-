<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>愛車メーター 動的ファネル分析</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- AOS (Animate On Scroll) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }
        .funnel-bar {
            height: 50px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-weight: bold;
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }
        .period-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .period-button {
            padding: 8px 16px;
            border-radius: 4px;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .period-button.active {
            background-color: #3182CE;
            color: white;
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #EDF2F7;
            border-radius: 4px 4px 0 0;
            margin-right: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab-button.active {
            background-color: #3182CE;
            color: white;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3182CE;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- ローディングオーバーレイ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loader"></div>
    </div>

    <div class="container mx-auto p-4 bg-white shadow-lg rounded-lg">
        <h1 class="text-2xl font-bold mb-6 text-center">愛車メーター 動的ファネル分析</h1>
        
        <!-- 期間選択 -->
        <div class="period-selector" data-aos="fade-up">
            <button class="period-button bg-gray-200 active" data-period="all">全期間</button>
            <button class="period-button bg-gray-200" data-period="feb">2月</button>
            <button class="period-button bg-gray-200" data-period="mar">3月</button>
            <button class="period-button bg-gray-200" data-period="week">週別表示</button>
        </div>
        
        <!-- 概要指標 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" data-aos="fade-up" data-aos-delay="100">
            <div class="card p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h3 class="text-lg font-medium text-blue-800 mb-2">全体コンバージョン率</h3>
                <p class="text-3xl font-bold text-blue-600"><span id="overallConversionRate">3.56</span>%</p>
                <p class="text-sm text-blue-600 mt-1">総アクセス数: <span id="totalAccess">24,999</span></p>
            </div>
            <div class="card p-4 bg-green-50 rounded-lg border border-green-200">
                <h3 class="text-lg font-medium text-green-800 mb-2">正常ルート効率</h3>
                <p class="text-3xl font-bold text-green-600"><span id="normalRouteRate">2.55</span>%</p>
                <p class="text-sm text-green-600 mt-1">初期ユーザー: <span id="normalUsers">21,866</span>人</p>
            </div>
            <div class="card p-4 bg-purple-50 rounded-lg border border-purple-200">
                <h3 class="text-lg font-medium text-purple-800 mb-2">概算ルート効率</h3>
                <p class="text-3xl font-bold text-purple-600"><span id="alternativeRouteRate">32.05</span>%</p>
                <p class="text-sm text-purple-600 mt-1">初期ユーザー: <span id="alternativeUsers">1,039</span>人</p>
            </div>
        </div>
        
        <!-- タブメニュー -->
        <div class="tabs mb-4" data-aos="fade-up" data-aos-delay="200">
            <div class="flex border-b">
                <button class="tab-button active" data-tab="funnels">ファネル分析</button>
                <button class="tab-button" data-tab="charts">グラフ分析</button>
                <button class="tab-button" data-tab="details">詳細データ</button>
            </div>
        </div>
        
        <!-- タブコンテンツ: ファネル分析 -->
        <div id="funnels" class="tab-content active">
            <!-- 正常ルートファネル -->
            <div class="mb-8" data-aos="fade-up" data-aos-delay="300">
                <h2 class="text-xl font-semibold mb-4">正常ルートファネル</h2>
                <div class="mb-6" id="normal-funnel">
                    <div class="funnel-bar bg-blue-500" style="width: 0%;" data-width="100">アクセス: <span class="access-count">24,999</span> (100%)</div>
                    <div class="funnel-bar bg-blue-500" style="width: 0%;" data-width="91.62">結果表示ボタン押下: <span class="button-count">22,905</span> (91.62%)</div>
                    <div class="funnel-bar bg-blue-500" style="width: 0%;" data-width="87.5">正常に結果表示: <span class="display-count">21,866</span> (95.46%)</div>
                    <div class="funnel-bar bg-blue-500" style="width: 0%;" data-width="15.0">保存ボタン押下: <span class="save-button-count">3,771</span> (17.25%)</div>
                    <div class="funnel-bar bg-blue-500" style="width: 0%;" data-width="15.4">実際の保存: <span class="actual-save-count">3,849</span> (102.07%)</div>
                    <div class="funnel-bar bg-blue-500" style="width: 0%;" data-width="5.75">正式査定進行: <span class="assessment-count">1,438</span> (37.36%)</div>
                    <div class="funnel-bar bg-blue-500" style="width: 0%;" data-width="2.23">査定依頼: <span class="request-count">557</span> (38.73%)</div>
                </div>
            </div>

            <!-- 概算査定ルートファネル -->
            <div class="mb-8" data-aos="fade-up" data-aos-delay="400">
                <h2 class="text-xl font-semibold mb-4">概算査定ルートファネル</h2>
                <div class="mb-6" id="alternative-funnel">
                    <div class="funnel-bar bg-purple-500" style="width: 0%;" data-width="4.5">結果表示できず: <span class="not-display-count">1,039</span> (4.5%)</div>
                    <div class="funnel-bar bg-purple-500" style="width: 0%;" data-width="1.5">概算査定フォーム申込: <span class="form-apply-count">333</span> (32.1%)</div>
                    <div class="funnel-bar bg-purple-500" style="width: 0%;" data-width="3.0">概算査定完了: <span class="form-complete-count">706</span> (67.9%)</div>
                </div>
            </div>

            <!-- ボトルネック分析 -->
            <div class="mt-4 p-4 bg-red-50 rounded-lg border border-red-200" data-aos="fade-up" data-aos-delay="500">
                <h3 class="text-lg font-medium text-red-800">主要ボトルネック</h3>
                <p class="text-xl font-bold text-red-600 mt-2">正常表示 → 保存ボタン押下 (<span id="bottleneck-rate">82.75</span>%)</p>
                <p class="text-sm text-red-600 mt-1"><span id="bottleneck-users">21,866</span>人中<span id="bottleneck-dropout">18,095</span>人がこのステップで離脱</p>
                <div class="mt-4">
                    <button id="showBottleneckAnalysis" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">詳細分析を表示</button>
                    <div id="bottleneckAnalysis" class="mt-4 p-4 bg-white rounded shadow-sm hidden">
                        <h4 class="font-bold mb-2">ボトルネック改善シミュレーション</h4>
                        <p>保存ボタン押下率が向上した場合のコンバージョン予測:</p>
                        <div class="grid grid-cols-3 gap-4 mt-2">
                            <div class="p-2 border rounded text-center">
                                <p class="text-sm">現状 (17.25%)</p>
                                <p class="font-bold">2.55%</p>
                            </div>
                            <div class="p-2 border rounded text-center">
                                <p class="text-sm">2倍 (34.5%)</p>
                                <p class="font-bold">5.1%</p>
                            </div>
                            <div class="p-2 border rounded text-center">
                                <p class="text-sm">3倍 (51.75%)</p>
                                <p class="font-bold">7.65%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- タブコンテンツ: グラフ分析 -->
        <div id="charts" class="tab-content">
            <!-- コンバージョン分布と効率比較 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8" data-aos="fade-up" data-aos-delay="300">
                <div>
                    <h2 class="text-xl font-semibold mb-4">コンバージョン分布</h2>
                    <div class="chart-container">
                        <canvas id="conversionDistribution"></canvas>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-semibold mb-4">ルート効率比較</h2>
                    <div class="chart-container">
                        <canvas id="routeEfficiency"></canvas>
                    </div>
                </div>
            </div>

            <!-- 週ごとの傾向 -->
            <div class="mb-8" data-aos="fade-up" data-aos-delay="400">
                <h2 class="text-xl font-semibold mb-4">週ごとの傾向</h2>
                <div class="chart-container">
                    <canvas id="weeklyTrend"></canvas>
                </div>
            </div>

            <!-- 各ステップの離脱率 -->
            <div class="mb-8" data-aos="fade-up" data-aos-delay="500">
                <h2 class="text-xl font-semibold mb-4">各ステップの離脱率</h2>
                <div class="chart-container">
                    <canvas id="dropoffRates"></canvas>
                </div>
            </div>

            <!-- 概算査定フォームパフォーマンス -->
            <div class="mb-8" data-aos="fade-up" data-aos-delay="600">
                <h2 class="text-xl font-semibold mb-4">概算査定フォームのパフォーマンス</h2>
                <div class="chart-container">
                    <canvas id="estimationFormPerformance"></canvas>
                </div>
            </div>
        </div>
        
        <!-- タブコンテンツ: 詳細データ -->
        <div id="details" class="tab-content">
            <div class="overflow-x-auto" data-aos="fade-up" data-aos-delay="300">
                <h2 class="text-xl font-semibold mb-4">日別詳細データ</h2>
                <table class="min-w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border p-2">日付</th>
                            <th class="border p-2">アクセス数</th>
                            <th class="border p-2">結果表示率</th>
                            <th class="border p-2">保存率</th>
                            <th class="border p-2">査定依頼率</th>
                            <th class="border p-2">概算申込率</th>
                        </tr>
                    </thead>
                    <tbody id="daily-data">
                        <!-- 日別データはJSで動的に生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-8" data-aos="fade-up" data-aos-delay="400">
                <h2 class="text-xl font-semibold mb-4">週別集計データ</h2>
                <table class="min-w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border p-2">週</th>
                            <th class="border p-2">アクセス数</th>
                            <th class="border p-2">正常ルート率</th>
                            <th class="border p-2">概算ルート率</th>
                            <th class="border p-2">全体変換率</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border p-2">2月1週</td>
                            <td class="border p-2">1,081</td>
                            <td class="border p-2">1.76%</td>
                            <td class="border p-2">1.48%</td>
                            <td class="border p-2">3.24%</td>
                        </tr>
                        <tr>
                            <td class="border p-2">2月2週</td>
                            <td class="border p-2">7,218</td>
                            <td class="border p-2">2.11%</td>
                            <td class="border p-2">2.01%</td>
                            <td class="border p-2">4.11%</td>
                        </tr>
                        <tr>
                            <td class="border p-2">2月3週</td>
                            <td class="border p-2">6,791</td>
                            <td class="border p-2">1.94%</td>
                            <td class="border p-2">1.63%</td>
                            <td class="border p-2">3.58%</td>
                        </tr>
                        <tr>
                            <td class="border p-2">2月4週</td>
                            <td class="border p-2">5,754</td>
                            <td class="border p-2">2.28%</td>
                            <td class="border p-2">1.06%</td>
                            <td class="border p-2">3.34%</td>
                        </tr>
                        <tr>
                            <td class="border p-2">3月1週</td>
                            <td class="border p-2">4,155</td>
                            <td class="border p-2">2.94%</td>
                            <td class="border p-2">0.00%</td>
                            <td class="border p-2">2.94%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 総合評価 -->
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 mt-8" data-aos="fade-up" data-aos-delay="700">
            <h2 class="text-xl font-semibold mb-2">総合評価と提案</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div class="p-3 bg-blue-50 rounded-lg">
                    <h3 class="font-bold text-blue-800">正常ルート最適化</h3>
                    <p class="text-sm mt-1">正常表示から保存ボタン押下へのステップを最適化することで、全体のコンバージョン率を大幅に向上できる可能性があります。</p>
                    <button class="mt-2 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition show-details">詳細を見る</button>
                    <div class="mt-2 hidden details-content">
                        <ul class="list-disc pl-4 text-xs">
                            <li>保存ボタンの視認性向上</li>
                            <li>保存のメリットを明確に表示</li>
                            <li>保存プロセスの簡略化</li>
                        </ul>
                    </div>
                </div>
                <div class="p-3 bg-purple-50 rounded-lg">
                    <h3 class="font-bold text-purple-800">概算ルートの効率活用</h3>
                    <p class="text-sm mt-1">概算ルートのコンバージョン率は32.05%と非常に高いため、このルートをより多くのユーザーに活用できる方法を検討する価値があります。</p>
                    <button class="mt-2 px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition show-details">詳細を見る</button>
                    <div class="mt-2 hidden details-content">
                        <ul class="list-disc pl-4 text-xs">
                            <li>特定条件下で意図的に概算ルートへ誘導</li>
                            <li>概算査定フォームのUI/UX改善</li>
                            <li>3月の概算ルート停止原因の調査</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // データセット
        const allData = {
            summary: {
                overallConversionRate: 3.56,
                totalAccess: 24999,
                normalRouteRate: 2.55,
                normalUsers: 21866,
                alternativeRouteRate: 32.05,
                alternativeUsers: 1039,
                bottleneckRate: 82.75,
                bottleneckUsers: 21866,
                bottleneckDropout: 18095
            },
            february: {
                overallConversionRate: 3.84,
                totalAccess: 20844,
                normalRouteRate: 2.33,
                normalUsers: 17956,
                alternativeRouteRate: 32.05,
                alternativeUsers: 1039,
                bottleneckRate: 81.72,
                bottleneckUsers: 17956,
                bottleneckDropout: 14676
            },
            march: {
                overallConversionRate: 2.94,
                totalAccess: 4155,
                normalRouteRate: 2.94,
                normalUsers: 3910,
                alternativeRouteRate: 0,
                alternativeUsers: 0,
                bottleneckRate: 85.71,
                bottleneckUsers: 3910,
                bottleneckDropout: 3351
            },
            weekly: {
                labels: ['2月1週', '2月2週', '2月3週', '2月4週', '3月1週'],
                normalRoute: [1.76, 2.11, 1.94, 2.28, 2.94],
                alternativeRoute: [1.48, 2.01, 1.63, 1.06, 0.00],
                totalRate: [3.24, 4.11, 3.58, 3.34, 2.94]
            },
            dailyData: [
                { date: '2025-02-07', access: 1081, displayRate: 92.0, saveRate: 11.8, requestRate: 1.8, formRate: 1.5 },
                { date: '2025-02-08', access: 1622, displayRate: 92.9, saveRate: 13.4, requestRate: 2.1, formRate: 1.7 },
                { date: '2025-02-09', access: 1330, displayRate: 92.0, saveRate: 15.6, requestRate: 2.7, formRate: 2.3 },
                { date: '2025-02-10', access: 805, displayRate: 91.6, saveRate: 14.7, requestRate: 2.5, formRate: 2.4 },
                { date: '2025-02-11', access: 947, displayRate: 91.0, saveRate: 13.7, requestRate: 2.5, formRate: 2.5 },
                { date: '2025-02-12', access: 921, displayRate: 91.9, saveRate: 10.6, requestRate: 1.2, formRate: 1.7 },
                { date: '2025-02-13', access: 896, displayRate: 91.5, saveRate: 13.5, requestRate: 1.8, formRate: 2.1 },
                { date: '2025-02-14', access: 697, displayRate: 90.1, saveRate: 10.6, requestRate: 1.6, formRate: 1.1 },
                { date: '2025-02-15', access: 1177, displayRate: 91.1, saveRate: 10.7, requestRate: 2.4, formRate: 1.5 },
                { date: '2025-02-16', access: 1807, displayRate: 91.8, saveRate: 12.2, requestRate: 1.5, formRate: 1.3 },
                { date: '2025-02-17', access: 977, displayRate: 90.3, saveRate: 16.0, requestRate: 1.4, formRate: 1.9 },
                { date: '2025-02-18', access: 938, displayRate: 91.7, saveRate: 16.8, requestRate: 1.3, formRate: 1.8 },
                { date: '2025-02-19', access: 739, displayRate: 92.3, saveRate: 16.5, requestRate: 3.2, formRate: 2.0 },
                { date: '2025-02-20', access: 600, displayRate: 91.2, saveRate: 17.0, requestRate: 2.2, formRate: 1.2 },
                { date: '2025-02-21', access: 553, displayRate: 91.7, saveRate: 14.6, requestRate: 2.5, formRate: 2.2 },
                { date: '2025-02-22', access: 932, displayRate: 90.3, saveRate: 16.4, requestRate: 2.6, formRate: 1.8 },
                { date: '2025-02-23', access: 737, displayRate: 90.8, saveRate: 20.1, requestRate: 3.0, formRate: 1.9 },
                { date: '2025-02-24', access: 770, displayRate: 91.2, saveRate: 17.4, requestRate: 1.9, formRate: 2.5 },
                { date: '2025-02-25', access: 797, displayRate: 92.7, saveRate: 17.3, requestRate: 2.3, formRate: 1.3 },
                { date: '2025-02-26', access: 884, displayRate: 92.3, saveRate: 16.6, requestRate: 1.7, formRate: 0.1 },
                { date: '2025-02-27', access: 909, displayRate: 93.3, saveRate: 18.9, requestRate: 1.8, formRate: 0.0 },
                { date: '2025-02-28', access: 725, displayRate: 92.1, saveRate: 16.1, requestRate: 2.9, formRate: 0.0 },
                { date: '2025-03-01', access: 780, displayRate: 90.5, saveRate: 15.4, requestRate: 3.8, formRate: 0.0 },
                { date: '2025-03-02', access: 835, displayRate: 93.3, saveRate: 18.9, requestRate: 4.2, formRate: 0.0 },
                { date: '2025-03-03', access: 686, displayRate: 91.5, saveRate: 15.9, requestRate: 2.3, formRate: 0.0 },
                { date: '2025-03-04', access: 608, displayRate: 91.4, saveRate: 16.3, requestRate: 2.6, formRate: 0.0 },
                { date: '2025-03-05', access: 652, displayRate: 91.3, saveRate: 18.1, requestRate: 1.7, formRate: 0.0 },
                { date: '2025-03-06', access: 594, displayRate: 89.4, saveRate: 18.5, requestRate: 2.4, formRate: 0.0 },
                { date: '2025-03-07', access: 0, displayRate: 0.0, saveRate: 0.0, requestRate: 0.0, formRate: 0.0 },
                { date: '2025-03-08', access: 0, displayRate: 0.0, saveRate: 0.0, requestRate: 0.0, formRate: 0.0 }
            ]
        };

        // チャートインスタンス
        let conversionDistribution;
        let routeEfficiency;
        let weeklyTrend;
        let dropoffRates;
        let estimationFormPerformance;

        // ローディング処理
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.getElementById('loadingOverlay').style.display = 'none';
                // ファネルバーのアニメーション
                animateFunnelBars();
            }, 1500);

            // AOS初期化
            AOS.init({
                duration: 800,
                once: true
            });
            
            // デイリーデータテーブル生成
            populateDailyData();
            
            // チャート初期化
            initCharts();
            
            // イベントリスナー設定
            setupEventListeners();
        });

        // ファネルバーのアニメーション
        function animateFunnelBars() {
            const normalBars = document.querySelectorAll('#normal-funnel .funnel-bar');
            const alternativeBars = document.querySelectorAll('#alternative-funnel .funnel-bar');
            
            normalBars.forEach((bar, index) => {
                setTimeout(() => {
                    bar.style.width = bar.getAttribute('data-width') + '%';
                }, index * 200);
            });
            
            setTimeout(() => {
                alternativeBars.forEach((bar, index) => {
                    setTimeout(() => {
                        bar.style.width = bar.getAttribute('data-width') + '%';
                    }, index * 200);
                });
            }, normalBars.length * 200);
        }

        // デイリーデータテーブル生成
        function populateDailyData() {
            const tbody = document.getElementById('daily-data');
            allData.dailyData.forEach(day => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border p-2">${day.date}</td>
                    <td class="border p-2">${day.access.toLocaleString()}</td>
                    <td class="border p-2">${day.displayRate.toFixed(1)}%</td>
                    <td class="border p-2">${day.saveRate.toFixed(1)}%</td>
                    <td class="border p-2">${day.requestRate.toFixed(1)}%</td>
                    <td class="border p-2">${day.formRate.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        // チャート初期化
        function initCharts() {
            // コンバージョン分布グラフ
            conversionDistribution = new Chart(
                document.getElementById('conversionDistribution'),
                {
                    type: 'pie',
                    data: {
                        labels: ['正常ルート', '概算ルート'],
                        datasets: [{
                            data: [557, 333],
                            backgroundColor: ['#3182CE', '#805AD5'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'コンバージョン内訳（合計890件）'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const percentage = (context.raw / (557 + 333) * 100).toFixed(1);
                                        return `${context.label}: ${context.raw}件 (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true
                        }
                    }
                }
            );

            // ルート効率比較グラフ
            routeEfficiency = new Chart(
                document.getElementById('routeEfficiency'),
                {
                    type: 'bar',
                    data: {
                        labels: ['正常ルート', '概算ルート'],
                        datasets: [
                            {
                                label: 'コンバージョン率 (%)',
                                data: [2.55, 32.05],
                                backgroundColor: '#805AD5',
                                yAxisID: 'y1'
                            },
                            {
                                label: 'ユーザー数',
                                data: [21866, 1039],
                                backgroundColor: '#3182CE',
                                yAxisID: 'y'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'ユーザー数'
                                }
                            },
                            y1: {
                                type: 'linear',
                                position: 'right',
                                max: 35,
                                title: {
                                    display: true,
                                    text: 'コンバージョン率 (%)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            }
                        },
                        animation: {
                            duration: 1000
                        }
                    }
                }
            );

            // 週ごとの傾向グラフ
            weeklyTrend = new Chart(
                document.getElementById('weeklyTrend'),
                {
                    type: 'line',
                    data: {
                        labels: allData.weekly.labels,
                        datasets: [
                            {
                                label: '正常ルート変換率 (%)',
                                data: allData.weekly.normalRoute,
                                borderColor: '#3182CE',
                                tension: 0.1
                            },
                            {
                                label: '概算ルート変換率 (%)',
                                data: allData.weekly.alternativeRoute,
                                borderColor: '#805AD5',
                                tension: 0.1
                            },
                            {
                                label: '全体変換率 (%)',
                                data: allData.weekly.totalRate,
                                borderColor: '#38A169',
                                tension: 0.1,
                                pointRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        animation: {
                            duration: 1000
                        }
                    }
                }
            );

            // 各ステップの離脱率グラフ
            dropoffRates = new Chart(
                document.getElementById('dropoffRates'),
                {
                    type: 'bar',
                    data: {
                        labels: [
                            'アクセス→結果表示',
                            '結果表示→正常表示',
                            '正常表示→保存ボタン',
                            '保存ボタン→保存',
                            '保存→正式査定進行',
                            '正式査定進行→依頼'
                        ],
                        datasets: [{
                            label: '離脱率 (%)',
                            data: [8.38, 4.54, 82.75, -2.07, 62.64, 61.27],
                            backgroundColor: '#E53E3E',
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        animation: {
                            duration: 1000
                        }
                    }
                }
            );

            // 概算査定フォームパフォーマンスグラフ
            estimationFormPerformance = new Chart(
                document.getElementById('estimationFormPerformance'),
                {
                    type: 'bar',
                    data: {
                        labels: [
                            '2025-02-11',
                            '2025-02-09',
                            '2025-02-13',
                            '2025-02-17',
                            '2025-02-10',
                            '平均',
                            '2025-02-07',
                            '2025-02-16',
                            '2025-02-14',
                            '2025-02-20',
                            '2025-02-25'
                        ],
                        datasets: [{
                            label: '変換率 (%)',
                            data: [27.59, 26.50, 25.68, 25.33, 24.68, 19.88, 16.67, 15.97, 13.79, 12.96, 11.49],
                            backgroundColor: '#805AD5',
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 30
                            }
                        },
                        animation: {
                            duration: 1000
                        }
                    }
                }
            );
        }

        // イベントリスナー設定
        function setupEventListeners() {
            // タブ切り替え
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // アクティブタブの切り替え
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // タブコンテンツの切り替え
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // チャートの再描画
                    if (tabId === 'charts') {
                        setTimeout(() => {
                            conversionDistribution.update();
                            routeEfficiency.update();
                            weeklyTrend.update();
                            dropoffRates.update();
                            estimationFormPerformance.update();
                        }, 100);
                    }
                });
            });
            
            // 期間選択
            document.querySelectorAll('.period-button').forEach(button => {
                button.addEventListener('click', function() {
                    const period = this.getAttribute('data-period');
                    
                    // アクティブボタンの切り替え
                    document.querySelectorAll('.period-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // データの更新
                    updateData(period);
                });
            });
            
            // ボトルネック詳細表示
            document.getElementById('showBottleneckAnalysis').addEventListener('click', function() {
                const analysis = document.getElementById('bottleneckAnalysis');
                if (analysis.classList.contains('hidden')) {
                    analysis.classList.remove('hidden');
                    this.textContent = '詳細分析を隠す';
                } else {
                    analysis.classList.add('hidden');
                    this.textContent = '詳細分析を表示';
                }
            });
            
            // 詳細を見るボタン
            document.querySelectorAll('.show-details').forEach(button => {
                button.addEventListener('click', function() {
                    const detailsContent = this.nextElementSibling;
                    if (detailsContent.classList.contains('hidden')) {
                        detailsContent.classList.remove('hidden');
                        this.textContent = '詳細を隠す';
                    } else {
                        detailsContent.classList.add('hidden');
                        this.textContent = '詳細を見る';
                    }
                });
            });
        }

        // データ更新
        function updateData(period) {
            let data;
            
            // 期間に応じたデータを選択
            if (period === 'feb') {
                data = allData.february;
            } else if (period === 'mar') {
                data = allData.march;
            } else {
                data = allData.summary;
            }
            
            // 要約指標の更新
            document.getElementById('overallConversionRate').textContent = data.overallConversionRate;
            document.getElementById('totalAccess').textContent = data.totalAccess.toLocaleString();
            document.getElementById('normalRouteRate').textContent = data.normalRouteRate;
            document.getElementById('normalUsers').textContent = data.normalUsers.toLocaleString();
            document.getElementById('alternativeRouteRate').textContent = data.alternativeRouteRate;
            document.getElementById('alternativeUsers').textContent = data.alternativeUsers.toLocaleString();
            document.getElementById('bottleneck-rate').textContent = data.bottleneckRate;
            document.getElementById('bottleneck-users').textContent = data.bottleneckUsers.toLocaleString();
            document.getElementById('bottleneck-dropout').textContent = data.bottleneckDropout.toLocaleString();
            
            // 週別表示の場合
            if (period === 'week') {
                // チャートタブをアクティブに
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('[data-tab="charts"]').classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById('charts').classList.add('active');
                
                // 週ごとの傾向グラフにフォーカス（少し拡大）
                setTimeout(() => {
                    weeklyTrend.canvas.parentNode.style.height = '400px';
                    weeklyTrend.update();
                }, 100);
            } else {
                weeklyTrend.canvas.parentNode.style.height = '300px';
                weeklyTrend.update();
            }
        }
    </script>
</body>
</html>
